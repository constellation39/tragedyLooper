graph TD
A[开始游戏] --> B{选择剧本};
B --> C[设置游戏: 根据剧本初始化角色、地点、计数器];
C --> D{循环开始};
D --> E[每日流程];

E --> F[主谋打牌 (3张, 面朝下)];
F --> G[主角打牌 (每人1张, 面朝下, 顺时针, 领队开始)];
G --> H[揭示所有卡牌];
H --> I[卡牌结算阶段];

I --> I1[1. 禁止移动卡结算];
I1 --> I2[2. 移动卡结算];
I2 --> I3[3. 其他禁止卡结算 (偏执, 善意, 阴谋)];
I3 --> I4[4. 其他卡牌效果结算 (偏执+/-, 善意+/-, 阴谋+/-)];
I4 --> J{能力激活阶段};

J --> K[主谋能力激活 (总是优先于主角)];
K --> L[主角善意能力激活 (领队选择)];
L --> M{事件检查与触发};

M --> N{是否满足强制事件条件?};
N -- 是 --> O[强制触发事件 (主谋必须触发)];
O --> P[应用事件后果 (例如: 角色死亡)];
P --> Q{检查循环失败条件};
N -- 否 --> Q;

Q --> R{循环是否失败 (例如: 关键人物死亡)?};
R -- 是 --> S[主谋揭示: "谁死了" (不揭示死因/凶手)];
S --> T{是否达到最大循环数?};
T -- 否 --> U[重置游戏组件 (保留主角知识)];
U --> D; /* 返回循环开始 */
T -- 是 --> V{最终猜测阶段};

R -- 否 --> W{是否所有失败条件都已阻止?};
W -- 是 --> X[主角获胜];
W -- 否 --> D; /* 继续下一个循环日 */

V --> Y[主角进行最终猜测 (所有角色真实身份)];
Y --> Z{最终猜测是否正确?};
Z -- 是 --> X; /* 主角获胜 */
Z -- 否 --> AA[主谋获胜];

X --> End[游戏结束];
AA --> End;